"""MalwareBazaar (abuse.ch) feed connector — malware file hashes.

Free API, no key required.
Docs: https://bazaar.abuse.ch/api/
"""

from __future__ import annotations

import uuid
from datetime import datetime, timezone

from app.core.logging import get_logger
from app.services.feeds.base import BaseFeedConnector

logger = get_logger(__name__)

MALWAREBAZAAR_API_URL = "https://mb-api.abuse.ch/api/v1/"


class MalwareBazaarConnector(BaseFeedConnector):
    FEED_NAME = "malwarebazaar"
    SOURCE_RELIABILITY = 80

    async def fetch(self, last_cursor: str | None = None) -> list[dict]:
        """Fetch recent malware samples from MalwareBazaar (last 1 hour)."""
        payload = {"query": "get_recent", "selector": "time"}
        response = await self.client.post(MALWAREBAZAAR_API_URL, data=payload)
        response.raise_for_status()
        data = response.json()

        query_status = data.get("query_status")
        if query_status == "no_results":
            logger.info("malwarebazaar_no_results")
            return []
        if query_status != "ok":
            logger.warning("malwarebazaar_query_failed", status=query_status)
            return []

        items = data.get("data", [])
        logger.info("malwarebazaar_fetch", total=len(items))

        # Incremental: filter by first_seen > last_cursor
        if last_cursor:
            try:
                cursor_dt = datetime.fromisoformat(last_cursor)
                items = [
                    i for i in items
                    if self._parse_date(i.get("first_seen"))
                    and self._parse_date(i.get("first_seen")) > cursor_dt
                ]
            except (ValueError, TypeError):
                pass

        return items[:500]

    def _parse_date(self, date_str: str | None) -> datetime | None:
        if not date_str:
            return None
        for fmt in ("%Y-%m-%d %H:%M:%S", "%Y-%m-%dT%H:%M:%S"):
            try:
                return datetime.strptime(date_str, fmt).replace(tzinfo=timezone.utc)
            except (ValueError, TypeError):
                continue
        return None

    def _severity_from_tags(self, tags: list[str]) -> str:
        """Heuristic severity from tags / known ransomware families."""
        tag_lower = [t.lower() for t in tags]
        critical_kw = {"ransomware", "apt", "cobalt", "cobaltstrike", "emotet", "trickbot", "qakbot"}
        high_kw = {"trojan", "rat", "stealer", "loader", "backdoor", "miner"}
        if critical_kw & set(tag_lower):
            return "critical"
        if high_kw & set(tag_lower):
            return "high"
        return "medium"

    def normalize(self, raw_items: list[dict]) -> list[dict]:
        items = []
        for raw in raw_items:
            sha256 = raw.get("sha256_hash", "")
            if not sha256:
                continue

            signature = raw.get("signature") or "unknown"
            file_type = raw.get("file_type", "unknown")
            file_name = raw.get("file_name", "unknown")
            file_size = raw.get("file_size", 0)

            tags_raw = raw.get("tags") or []
            tags = list(tags_raw) if isinstance(tags_raw, list) else []
            tags.append("malwarebazaar")
            if signature and signature != "unknown":
                tags.append(signature.lower().replace(" ", "_"))

            published_at = self._parse_date(raw.get("first_seen"))
            severity = self._severity_from_tags(tags)

            reporter = raw.get("reporter", "anonymous")
            delivery = raw.get("delivery_method") or "N/A"

            items.append({
                "id": uuid.uuid4(),
                "title": f"[MalwareBazaar] {signature}: {sha256[:16]}…",
                "summary": (
                    f"File: {file_name} | Type: {file_type} | Size: {file_size} B | "
                    f"Sig: {signature}"
                ),
                "description": (
                    f"Malware sample from MalwareBazaar. SHA256: {sha256}. "
                    f"MD5: {raw.get('md5_hash', 'N/A')}. SHA1: {raw.get('sha1_hash', 'N/A')}. "
                    f"File: {file_name} ({file_type}, {file_size} bytes). "
                    f"Signature: {signature}. Delivery: {delivery}. Reporter: {reporter}."
                ),
                "published_at": published_at,
                "ingested_at": self.now_utc(),
                "updated_at": self.now_utc(),
                "severity": severity,
                "risk_score": 0,
                "confidence": 80,
                "source_name": "MalwareBazaar",
                "source_url": f"https://bazaar.abuse.ch/sample/{sha256}/",
                "source_reliability": self.SOURCE_RELIABILITY,
                "source_ref": sha256,
                "feed_type": "ioc",
                "asset_type": "hash_sha256",
                "tlp": "TLP:CLEAR",
                "tags": tags,
                "geo": [],
                "industries": [],
                "cve_ids": [],
                "affected_products": [],
                "related_ioc_count": 1,
                "is_kev": False,
                "exploit_available": False,
                "exploitability_score": None,
                "source_hash": self.generate_hash("malwarebazaar", sha256),
            })

        return items
